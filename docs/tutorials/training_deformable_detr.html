

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Training Deformable DETR &mdash; Aloception 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Finetuning Deformanble DETR" href="finetuning_deformable_detr.html" />
    <link rel="prev" title="Training Panoptic Head module" href="training_panoptic.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Aloception
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Geting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/aloscene.html">Aloscene: Computer vision with ease</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/alodataset.html">Alodataset: Loading your vision datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/alonet.html">Alonet : Training your models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/augmented_tensor.html">About augmented tensors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Turorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_setup.html">How to setup your data?</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_detr.html">Training Detr</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetuning_detr.html">Finetuning DETR</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_panoptic.html">Training Panoptic Head module</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Training Deformable DETR</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#1.-Deformable-DETR-trainer">1. Deformable DETR trainer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#2.-Make-inferences">2. Make inferences</a></li>
<li class="toctree-l2"><a class="reference internal" href="#3.-Model-performance-comparison">3. Model performance comparison</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="finetuning_deformable_detr.html">Finetuning Deformanble DETR</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensort_inference.html">Exporting DETR / Deformable-DETR to TensorRT</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Aloception API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aloscene/aloscene.html">Aloscene</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alodataset/alodataset.html">Alodataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alonet/alonet.html">Alonet</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Aloception</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Training Deformable DETR</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/training_deformable_detr.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Training-Deformable-DETR">
<h1>Training Deformable DETR<a class="headerlink" href="#Training-Deformable-DETR" title="Permalink to this headline">¶</a></h1>
<p>This tutorial explains how to use <a class="reference internal" href="../alonet/deformable_training.html#alonet.deformable_detr.train.LitDeformableDetr"><span class="std std-ref">LitDeformableDetr</span></a> module to train <a class="reference external" href="https://arxiv.org/abs/2010.04159">Deformable DetrR50 architecture</a> from scratch, using <a class="reference external" href="https://cocodataset.org/#detection-2017">COCO2017 detection dataset</a> as input.</p>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>Goals</strong></p>
<ol class="arabic simple">
<li><p>Learn about how to instantiate and run <a class="reference internal" href="../alonet/deformable_training.html#alonet.deformable_detr.train.LitDeformableDetr"><span class="std std-ref">LitDeformableDetr</span></a> train</p></li>
<li><p>Load trained weights and make inference with pre-trained weights</p></li>
<li><p>Compare performance between <a class="reference internal" href="../alonet/detr_training.html#alonet.detr.train.LitDetr"><span class="std std-ref">LitDetr</span></a> and <a class="reference internal" href="../alonet/deformable_training.html#alonet.deformable_detr.train.LitDeformableDetr"><span class="std std-ref">LitDeformableDetr</span></a></p></li>
</ol>
</div>
<div class="section" id="1.-Deformable-DETR-trainer">
<h2>1. Deformable DETR trainer<a class="headerlink" href="#1.-Deformable-DETR-trainer" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../index.html"><span class="doc">Aloception</span></a> is developed under the <a class="reference external" href="https://www.pytorchlightning.ai/">Pytorch Lightning</a> framework, and provides different modules that facilitate the use of datasets and training models. Like <a class="reference internal" href="../alonet/detr_training.html#alonet.detr.train.LitDetr"><span class="std std-ref">LitDetr</span></a>, <a class="reference internal" href="../alonet/deformable_training.html#alonet.deformable_detr.train.LitDeformableDetr"><span class="std std-ref">LitDeformableDetr</span></a> allows the initialization of its parameters according to five levels:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">alonet.deformable_detr</span> <span class="kn">import</span> <span class="n">LitDeformableDetr</span><span class="p">,</span> <span class="n">DeformableDetrR50Finetune</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">Namespace</span>

<span class="k">def</span> <span class="nf">params2Namespace</span><span class="p">(</span><span class="n">litdetr</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] LEVEL </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">(</span>
        <span class="n">accumulate_grad_batches</span><span class="o">=</span><span class="n">litdetr</span><span class="o">.</span><span class="n">accumulate_grad_batches</span><span class="p">,</span>
        <span class="n">gradient_clip_val</span><span class="o">=</span><span class="n">litdetr</span><span class="o">.</span><span class="n">gradient_clip_val</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">litdetr</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">litdetr</span><span class="o">.</span><span class="n">weights</span>
    <span class="p">))</span>

<span class="c1"># Level 1</span>
<span class="c1"># Create LightningModule with default parameters</span>
<span class="n">lit_deformable</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">()</span>
<span class="n">params2Namespace</span><span class="p">(</span><span class="n">lit_deformable</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Level 2</span>
<span class="c1"># Define LightningModule changing some parameters</span>
<span class="n">lit_deformable</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">(</span><span class="n">accumulate_grad_batches</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">params2Namespace</span><span class="p">(</span><span class="n">lit_deformable</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Level 3</span>
<span class="c1"># Use namespace to define attribute values</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="o">.</span><span class="n">add_argparse_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>
<span class="n">lit_deformable</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="n">params2Namespace</span><span class="p">(</span><span class="n">lit_deformable</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Level 4</span>
<span class="c1"># Combine previous approaches.</span>
<span class="n">my_model</span> <span class="o">=</span> <span class="n">DeformableDetrR50Finetune</span><span class="p">(</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;deformable-detr-r50&quot;</span><span class="p">)</span>
<span class="n">lit_deformable</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">my_model</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;finetune&quot;</span><span class="p">)</span>
<span class="n">params2Namespace</span><span class="p">(</span><span class="n">lit_deformable</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>Hint</strong></p>
<p>For a more detailed explanation, see the tutorial on <a class="reference internal" href="training_detr.html"><span class="doc">how to train a Detr model</span></a>.</p>
</div>
<p>Now, a common example of the training pipeline in <a class="reference internal" href="../index.html"><span class="doc">Aloception</span></a> is described below:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>

<span class="kn">import</span> <span class="nn">alonet</span>
<span class="kn">from</span> <span class="nn">alonet.detr</span> <span class="kn">import</span> <span class="n">CocoDetection2Detr</span>
<span class="kn">from</span> <span class="nn">alonet.deformable_detr</span> <span class="kn">import</span> <span class="n">LitDeformableDetr</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Parameters definition</span>
<span class="c1"># Build parser (concatenates arguments to modify the entire project)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">conflict_handler</span><span class="o">=</span><span class="s2">&quot;resolve&quot;</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">CocoDetection2Detr</span><span class="o">.</span><span class="n">add_argparse_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="o">.</span><span class="n">add_argparse_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">alonet</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">add_argparse_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>  <span class="c1"># Add common arguments in train process</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>

<span class="c1"># Dataset use to train</span>
<span class="n">coco_loader</span> <span class="o">=</span> <span class="n">CocoDetection2Detr</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="n">lit_deformable</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># Train process</span>
<span class="c1"># args.save = True # Uncomment this line to store trained weights</span>
<span class="n">lit_deformable</span><span class="o">.</span><span class="n">run_train</span><span class="p">(</span>
    <span class="n">data_loader</span><span class="o">=</span><span class="n">coco_loader</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;deformable&quot;</span><span class="p">,</span>
    <span class="n">expe_name</span><span class="o">=</span><span class="s2">&quot;coco_detr&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>Note</strong></p>
<p><a class="reference internal" href="../alonet/deformable_models.html#module-alonet.deformable_detr.deformable_detr_r50_refinement"><span class="std std-ref">Deformable DETR R50 with refinement</span></a> architecture is used by default in the definition of the <a class="reference internal" href="../alonet/deformable_training.html#alonet.deformable_detr.train.LitDeformableDetr"><span class="std std-ref">LitDeformableDetr</span></a> class. However, we can change the model to <a class="reference internal" href="../alonet/deformable_models.html#module-alonet.deformable_detr.deformable_detr_r50"><span class="std std-ref">Deformable DETR R50</span></a> architecture setting
<code class="docutils literal notranslate"><span class="pre">model_name</span> <span class="pre">=</span> <span class="pre">&quot;deformable-detr-r50&quot;</span></code> in the class instance.</p>
</div>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>Hint</strong></p>
<p>Learn the difference betweent <a class="reference internal" href="../alonet/deformable_models.html#module-alonet.deformable_detr.deformable_detr_r50"><span class="std std-ref">Deformable DETR R50</span></a> and <a class="reference internal" href="../alonet/deformable_models.html#module-alonet.deformable_detr.deformable_detr_r50_refinement"><span class="std std-ref">Deformable DETR R50 with refinement</span></a> (<strong>Iterative Bounding Box Refinement</strong>) in <a class="reference external" href="https://arxiv.org/abs/2010.04159">Deformable DETR: Deformable Transformers for End-to-End Object Detection</a> article.</p>
</div>
<div class="admonition warning">
<p class="admonition-title fa fa-exclamation-circle"><strong>Attention</strong></p>
<p>This code has a high computational cost and demands several hours of training, given its initialization from scratch. It is recommended to skip to the next section to see the results of the trained network.</p>
</div>
</div>
<div class="section" id="2.-Make-inferences">
<h2>2. Make inferences<a class="headerlink" href="#2.-Make-inferences" title="Permalink to this headline">¶</a></h2>
<p>Once the training is finished, we can load the trained weights knowing the project and run id (<code class="docutils literal notranslate"><span class="pre">~/.aloception/project_run_id/run_id</span></code> path). For this, a function of the common module of aloception could be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">alonet.common</span> <span class="kn">import</span> <span class="n">load_training</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">project_run_id</span> <span class="o">=</span> <span class="s2">&quot;project_run_id&quot;</span><span class="p">,</span> <span class="n">run_id</span> <span class="o">=</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>
<span class="n">lit_detr</span> <span class="o">=</span> <span class="n">load_training</span><span class="p">(</span><span class="n">LitDeformableDetr</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Moreover, <a class="reference internal" href="../alonet/deformable_training.html#alonet.deformable_detr.train.LitDeformableDetr"><span class="std std-ref">LitDeformableDetr</span></a> allows download and load pre-trained weights for use. This is achieved by using the <code class="docutils literal notranslate"><span class="pre">weights</span></code> attribute:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lit_detr</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">(</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;deformable-detr-r50&quot;</span><span class="p">,</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;deformable-detr-r50&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>Note</strong></p>
<p>Setting <code class="docutils literal notranslate"><span class="pre">weights</span> <span class="pre">=</span> <span class="pre">&quot;deformable-detr-r50&quot;</span></code> and removing <code class="docutils literal notranslate"><span class="pre">model_name</span></code>, <a class="reference internal" href="../alonet/deformable_models.html#module-alonet.deformable_detr.deformable_detr_r50_refinement"><span class="std std-ref">Deformable DETR R50 with refinement</span></a> will be instantiated and loaded with the pre-trained weights.</p>
</div>
<p>To conclude, we could make some detections with the following code:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">alonet.detr</span> <span class="kn">import</span> <span class="n">CocoDetection2Detr</span>
<span class="kn">from</span> <span class="nn">alonet.deformable_detr</span> <span class="kn">import</span> <span class="n">LitDeformableDetr</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Dataset use to train</span>
<span class="n">coco_loader</span> <span class="o">=</span> <span class="n">CocoDetection2Detr</span><span class="p">()</span>
<span class="n">lit_deformable</span> <span class="o">=</span> <span class="n">LitDeformableDetr</span><span class="p">(</span><span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;deformable-detr-r50-refinement&quot;</span><span class="p">)</span>
<span class="n">lit_deformable</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">lit_deformable</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Check a random result</span>
<span class="n">frame</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">coco_loader</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">()))</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">batch_list</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">lit_deformable</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">lit_deformable</span><span class="p">(</span><span class="n">frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Inference from forward result</span>
<span class="n">gt_boxes</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">boxes2d</span>

<span class="n">frame</span><span class="o">.</span><span class="n">get_view</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">gt_boxes</span><span class="o">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Ground truth boxes&quot;</span><span class="p">),</span>
        <span class="n">pred_boxes</span><span class="o">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predicted boxes&quot;</span><span class="p">),</span>
    <span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1080</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="3.-Model-performance-comparison">
<h2>3. Model performance comparison<a class="headerlink" href="#3.-Model-performance-comparison" title="Permalink to this headline">¶</a></h2>
<p>In order to compare the performance of the object detection models presented in the training tutorials, we can use the <a class="reference internal" href="../alonet/alonet.metrics.html"><span class="doc">AP Metrics</span></a> module that allows to calculate different metrics based on Average Precision (AP).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">alonet.metrics</span> <span class="kn">import</span> <span class="n">ApMetrics</span>
<span class="kn">from</span> <span class="nn">alonet.detr</span> <span class="kn">import</span> <span class="n">CocoDetection2Detr</span><span class="p">,</span> <span class="n">LitDetr</span>
<span class="kn">from</span> <span class="nn">alonet.deformable_detr</span> <span class="kn">import</span> <span class="n">LitDeformableDetr</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Models to compare in COCO dataset</span>
<span class="n">lit_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lit_detr&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">LitDetr</span><span class="p">(</span><span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;detr-r50&quot;</span><span class="p">),</span>
        <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">ApMetrics</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="s2">&quot;lit_deformable&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">LitDeformableDetr</span><span class="p">(</span><span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;deformable-detr-r50-refinement&quot;</span><span class="p">),</span>
        <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">ApMetrics</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">coco_loader</span> <span class="o">=</span> <span class="n">CocoDetection2Detr</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">lit_model</span> <span class="ow">in</span> <span class="n">lit_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">lit_model</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">lit_model</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coco_loader</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">()):</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">batch_list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">gt_boxes</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">boxes2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lit_model</span> <span class="ow">in</span> <span class="n">lit_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">lit_model</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
        <span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">lit_model</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_sample</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">,</span> <span class="n">gt_boxes</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;it:</span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">lit_model</span> <span class="ow">in</span> <span class="n">lit_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> model:&quot;</span><span class="p">)</span>
    <span class="n">lit_model</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">calc_map</span><span class="p">(</span><span class="n">print_result</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>What is next?</strong></p>
<p>Learn how to train a custom architecture in <a class="reference internal" href="finetuning_deformable_detr.html"><span class="doc">Finetuning Deformable DETR</span></a> tutorial.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="finetuning_deformable_detr.html" class="btn btn-neutral float-right" title="Finetuning Deformanble DETR" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="training_panoptic.html" class="btn btn-neutral float-left" title="Training Panoptic Head module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Visual Behavior.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>